<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 10px;
        font-family: 'Segoe UI VSS (Regular)', '-apple-system', BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .task-genie-button {
        background-color: #0078d4;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 2px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
        transition: background-color 0.2s;
      }

      .task-genie-button:hover {
        background-color: #106ebe;
      }

      .task-genie-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .checkbox-container {
        display: flex;
        align-items: center;
        font-size: 13px;
        color: #333;
        cursor: pointer;
      }

      .checkbox-container input {
        margin-right: 6px;
      }

      .status-message {
        margin-top: 4px;
        font-size: 12px;
        color: #666;
        min-height: 16px;
        display: block;
      }

      .error-message {
        color: #d13438;
      }

      .success-message {
        color: #107c10;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="controls">
        <button id="taskGenieButton" class="task-genie-button">Generate</button>
        <label class="checkbox-container">
            <input type="checkbox" id="previewCheckbox">
            Preview
        </label>
      </div>
      <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
      window.requirejs.config({
        enforceDefine: true,
        paths: {
          SDK: './lib/SDK.min',
        },
      });

      window.requirejs(['SDK'], function (SDK) {
        console.log('RequireJS loaded SDK module:', typeof SDK);

        if (typeof SDK !== 'undefined') {
          console.log('SDK is defined. Initializing work item form control...');
          console.log('Available SDK methods:', Object.keys(SDK));

          SDK.init()
            .then(() => {
              console.log('SDK initialized');
              return SDK.ready();
            })
            .then(() => {
              console.log('SDK loaded');

              // Register the work item form service
              SDK.register(SDK.getContributionId(), () => {
                return {
                  // Called when the work item is loaded
                  onLoaded: function (workItemLoadedArgs) {
                    console.log('Work item loaded:', workItemLoadedArgs);
                    setupButton();
                  },
                  
                  // Called when work item field values change
                  onFieldChanged: function (fieldChangedArgs) {
                    // console.log('Field changed:', fieldChangedArgs);
                  },

                  // Called before the work item is saved
                  onSaved: function (savedEventArgs) {
                    // console.log('Work item saved:', savedEventArgs);
                  },

                  // Called when the work item is reset/reverted
                  onReset: function (undoEventArgs) {
                    // console.log('Work item reset:', undoEventArgs);
                  },

                  // Called when the work item is refreshed
                  onRefreshed: function (refreshEventArgs) {
                    // console.log('Work item refreshed:', refreshEventArgs);
                  },
                };
              });

              // function setupButton() {
              async function setupButton() {
                const button = document.getElementById('taskGenieButton');
                const statusMessage = document.getElementById('statusMessage');
                const previewCheckbox = document.getElementById('previewCheckbox');

                // Get configuration values from extension inputs
                const config = SDK.getConfiguration();
                const apiUrl = config.witInputs['ApiUrl'] || '';
                const apiKey = config.witInputs['ApiKey'] || '';

                // Get work item type to set appropriate button text
                try {
                  const workItemFormService = await SDK.getService('ms.vss-work-web.work-item-form');
                  const fields = await workItemFormService.getFieldValues(['System.WorkItemType', 'System.AreaPath']);
                  const workItemType = fields['System.WorkItemType'];
                  const areaPath = fields['System.AreaPath'];
                  
                  button.textContent = 'Generate';

                  // TEMP (PILOT ONLY) - Check if current work item is in the allowed area path
                  // Check if the area path matches any of the allowed pilot teams
                  const allowedAreaPaths = [
                    'eric-agile-test',
                    'eric-scrum-test',
                    'eric-agile-dev',
                    'eric-scrum-dev',
                    'AMA-Ent\\Software Development\\Orange Team',
                    'AMA-Ent\\Software Development\\Blue Team',
                    'AMA-Ent\\AI CoE\\AI Foundation',
                    'Digital Experience Dev\\Rewards and Registries',
                    'Digital Experience Dev\\Rewards and Registries\\Dev',
                  ];

                  if (!allowedAreaPaths.includes(areaPath)) {
                    // Disable button and show pilot message for non-pilot teams
                    button.disabled = true;
                    statusMessage.textContent = 'Currently only enabled for pilot teams';
                    statusMessage.className = 'status-message';
                    return;
                  }
                } catch (error) {
                  console.error('Error checking work item type or area path:', error);
                  button.disabled = true;
                  statusMessage.textContent = 'Currently only enabled for pilot teams';
                  statusMessage.className = 'status-message';
                  return;
                }
                // TEMP (PILOT ONLY) - End

                button.addEventListener('click', async function () {
                  const isPreview = previewCheckbox.checked;

                  button.disabled = true;
                  previewCheckbox.disabled = true;
                  statusMessage.textContent = isPreview ? 'Submitting request...do not leave this tab' : 'Submitting request...';
                  statusMessage.className = 'status-message';

                  try {
                    // Get the current work item
                    const workItemFormService = await SDK.getService('ms.vss-work-web.work-item-form');

                    const workItemId = await workItemFormService.getId();
                    const revision = await workItemFormService.getRevision();
                    const fields = await workItemFormService.getFieldValues([
                      // Base fields for all work item types
                      'System.Title',
                      'System.Description',
                      'System.WorkItemType',
                      'System.ChangedBy',
                      'System.Tags',
                      'System.TeamProject',
                      'System.AreaPath',
                      'System.IterationPath',
                      // User Story specific fields
                      'Microsoft.VSTS.Common.AcceptanceCriteria',
                      'Custom.Importance',
                      // Epic specific fields
                      'Custom.SuccessCriteria',
                      'Custom.Objective',
                      'Custom.AddressedRisks',
                      'Custom.PursueRisk',
                      'Custom.MostRecentUpdate',
                      'Custom.OutstandingActionItems',
                      // Feature specific fields
                      'Custom.BusinessDeliverable',
                      // Common custom fields
                      'Custom.AMAValueArea',
                      'Custom.BusinessUnit',
                      'Custom.System',
                      'Custom.ReleaseNotes',
                      'Custom.QANotes',
                    ]);
                    
                    // Call your REST API here
                    await callTaskGenieAPI(statusMessage, workItemId, fields, revision, { preview: isPreview });

                    button.disabled = true;
                    previewCheckbox.disabled = true;
                  } catch (error) {
                    console.error('An error occurred:', error);
                    statusMessage.textContent = 'An error occurred. Please try again.';
                    statusMessage.className = 'status-message error-message';
                  } finally {
                    button.disabled = false;
                    previewCheckbox.disabled = false;

                    // Clear status message after 5 seconds
                    setTimeout(() => {
                      statusMessage.textContent = '';
                    }, 5000);
                  }
                });
              }
              
              async function callTaskGenieAPI(statusMessage, workItemId, fields, revision, params) {
                // Get configuration values from extension inputs
                const config = SDK.getConfiguration();

               // Get API URL and API Key from configuration
                const apiUrl = config.witInputs['ApiUrl'] || '';
                const apiKey = config.witInputs['ApiKey'] || '';

                console.log('Calling Task Genie API:', {
                  workItemId: workItemId,
                  revision: revision,
                  fields,
                  apiUrl,
                  apiKey: apiKey.substring(0, 4) + '***' + apiKey.substring(apiKey.length - 4),
                  params,
                });

                const requestBody = {
                  resource: {
                    workItemId: workItemId,
                    rev: revision,
                    revision: {
                      fields: {
                        // Base fields
                        'System.ChangedBy': fields['System.ChangedBy'],
                        'System.WorkItemType': fields['System.WorkItemType'],
                        'System.Title': fields['System.Title'],
                        'System.Description': fields['System.Description'],
                        'System.TeamProject': fields['System.TeamProject'],
                        'System.Tags': fields['System.Tags'],
                        'System.AreaPath': fields['System.AreaPath'],
                        'System.IterationPath': fields['System.IterationPath'],
                        // User Story specific fields
                        'Microsoft.VSTS.Common.AcceptanceCriteria': fields['Microsoft.VSTS.Common.AcceptanceCriteria'],
                        'Custom.Importance': fields['Custom.Importance'],
                        // Epic specific fields
                        'Custom.SuccessCriteria': fields['Custom.SuccessCriteria'],
                        'Custom.Objective': fields['Custom.Objective'],
                        'Custom.AddressedRisks': fields['Custom.AddressedRisks'],
                        'Custom.PursueRisk': fields['Custom.PursueRisk'],
                        'Custom.MostRecentUpdate': fields['Custom.MostRecentUpdate'],
                        'Custom.OutstandingActionItems': fields['Custom.OutstandingActionItems'],
                        // Feature specific fields
                        'Custom.BusinessDeliverable': fields['Custom.BusinessDeliverable'],
                        // Common custom fields
                        'Custom.AMAValueArea': fields['Custom.AMAValueArea'],
                        'Custom.BusinessUnit': fields['Custom.BusinessUnit'],
                        'Custom.System': fields['Custom.System'],
                        'Custom.ReleaseNotes': fields['Custom.ReleaseNotes'],
                        'Custom.QANotes': fields['Custom.QANotes'],
                      },
                    },
                  },
                  params,
                };

                const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                  },
                  body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Task Genie response:', result);

                // Extract Execution ID
                // Response format: { message: "...", executionArn: "...", startDate: "..." }
                const executionArn = result.executionArn;
                if (!executionArn) {
                  throw new Error('No execution ARN received from API');
                }
                const executionId = executionArn.split(':').slice(-2).join(':');

               if (params.preview) {
                  console.log("Polling for results for executionId: " + executionId);

                  // Poll for results
                  const result = await pollForCompletion(apiUrl, apiKey, executionId);
                  console.log('Task Genie result:', result);

                  const workItems = result.result.workItems;
                  console.log('Task Genie workItems:', workItems);

                  // Save results to localStorage for the Tab to pick up
                  try {
                      console.log('Attempting to save to localStorage...');
                      console.log('Origin:', window.location.origin);
                      
                      const resultKey = `taskGenie_results_${workItemId}`;
                      const payload = {
                          workItems: workItems,
                          workItem: requestBody,
                          config: { apiUrl, apiKey },
                          timestamp: Date.now()
                      };
                      
                      // Use localStorage (shared across frames on same origin)
                      localStorage.setItem(resultKey, JSON.stringify(payload));
                      console.log('Saved generated items to localStorage:', resultKey);
                      
                      statusMessage.textContent = 'Tasks generated! Please check the Task Genie tab.';
                      statusMessage.className = 'status-message success-message';
                  } catch (err) {
                      console.error('Failed to save simple storage', err);
                      // Log the stack for more details
                      if (err.stack) console.error(err.stack);
                        statusMessage.textContent = 'Tasks generated, but failed to send to tab. Check console.';
                        statusMessage.className = 'status-message error-message';
                  }

                } else {
                    // Let it asynchronously complete
                    statusMessage.textContent = 'Task Genie is processing...';
                    setTimeout(() => statusMessage.textContent = '', 5000);
                }
              }

              async function pollForCompletion(apiUrl, apiKey, executionId) {
                console.log(`Polling ${apiUrl}/${executionId}`);

                const pollUrl = `${apiUrl}/${executionId}`;
                const maxAttempts = 60; // 300 seconds timeout
                const delay = 5000;

                for (let i = 0; i < maxAttempts; i++) {
                  await new Promise(resolve => setTimeout(resolve, delay));

                  try {
                    console.log(`Polling ${pollUrl}`);

                    const resp = await fetch(pollUrl, { headers: { 'x-api-key': apiKey } });
                    console.log(`Response: ${resp.status}`);
                          
                    if (resp.status === 200) {
                      const data = await resp.json();
                      if (data.status === 'completed') {
                        return data;
                      } else if (data.status === 'failed') {
                        throw new Error('Task Genie execution failed');
                      }
                      // If 'running' or other status, loop continues
                    }
                  } catch (e) {
                      console.error("Polling error:", e);
                      // Continue polling on error
                  }
                }
                throw new Error('Polling timed out');
              }
            })
            .catch((error) => {
              console.error('Error initializing SDK:', error);
            });
        }
      });
    </script>
  </body>
</html>
